<?php
session_start();

//conn settings
$dbhost="localhost";
$dbuname="root";
$dbupass="lofaszka";
//$dbupass="";
$dbname="characters";

//database connection 
 $dbi = mysql_connect($dbhost, $dbuname, $dbupass,true) or die("Couldn't connect to database server!");
 mysql_select_db($dbname, $dbi) or die("Q 200603201239".mysql_error($dbi));

//timeout for the page
set_time_limit ( 2*60*60*10 ); 

$remove_spells_from_char = array(324,379,724,974,1329,3409,3674,5374,5952,9799,10060,11078,11080,11083,11094,11095,11103,11113,11115,11119,11120,11129,11151,11170,11175,11185,11190,11210,11213,11255,11366,11367,11426,11958,12042,12043,12289,12290,12292,12294,12295,12296,12298,12299,12311,12317,12319,12320,12321,12322,12323,12328,12329,12330,12355,12357,12472,12484,12485,12487,12489,12536,12569,12571,12574,12575,12592,12598,12654,12668,12676,12712,12721,12723,12724,12725,12761,12762,12797,12799,12809,12834,12835,12846,12849,12852,12867,12872,12873,12880,12950,12952,12953,12958,12963,12964,12966,12967,12968,12971,12972,12975,12976,12982,13045,13046,13705,13712,13732,13733,13741,13743,13750,13754,13788,13789,13793,13832,13843,13852,13863,13865,13866,13867,13875,13877,13975,13976,13977,13979,13981,14057,14062,14066,14072,14079,14080,14117,14128,14132,14135,14156,14157,14158,14159,14160,14161,14162,14163,14164,14165,14166,14168,14169,14171,14172,14177,14179,14181,14183,14185,14186,14189,14190,14201,14202,14520,14523,14747,14748,14751,14768,14770,14771,14780,14781,14892,14893,14898,14908,14910,15020,15259,15273,15274,15275,15286,15290,15307,15308,15311,15312,15313,15317,15357,15362,15392,15407,15448,15473,15487,16035,16038,16039,16040,16086,16105,16106,16109,16113,16160,16164,16166,16173,16176,16177,16179,16180,16187,16188,16190,16196,16205,16213,16214,16215,16222,16235,16236,16246,16252,16256,16257,16261,16262,16266,16277,16278,16281,16282,16287,16290,16306,16307,16487,16488,16489,16490,16491,16492,16493,16494,16511,16513,16514,16515,16544,16814,16815,16816,16833,16834,16845,16846,16847,16858,16859,16870,16880,16913,16929,16930,16931,16940,16941,16949,16952,16954,16958,16961,16972,16974,16979,17002,17003,17004,17005,17007,17056,17058,17059,17069,17070,17074,17075,17076,17080,17104,17111,17112,17113,17116,17364,17485,17486,17487,17788,17789,17790,17793,17796,17800,17801,17804,17805,17810,17811,17812,17815,17833,17877,17927,17929,17941,17954,17955,17962,18094,18095,18118,18119,18120,18179,18182,18183,18223,18425,18427,18428,18429,18459,18460,18469,18498,18530,18531,18533,18562,18694,18697,18698,18699,18703,18704,18709,18710,18827,18829,19184,19185,19236,19286,19287,19306,19376,19386,19387,19416,19417,19418,19434,19464,19506,19559,19560,19572,19573,19574,19577,19578,19579,19590,19592,19596,19615,19621,19622,19623,20049,20050,20052,20053,20056,20057,20066,20113,20138,20139,20140,20143,20144,20145,20174,20175,20177,20178,20179,20224,20225,20234,20235,20237,20238,20243,20359,20360,20424,20473,20487,20488,20502,20503,20711,20895,20911,20925,22959,23145,23588,23602,23694,23880,23881,23885,23922,23989,24131,24394,24406,24529,24858,24864,24866,24867,24905,24932,24943,25912,25914,25956,25988,25997,26016,26017,26022,26023,26364,26654,27576,28996,28997,28998,28999,29000,29074,29075,29077,29079,29144,29179,29180,29341,29447,29592,29593,29594,29598,29723,29725,29801,29834,29836,29838,29841,29842,29859,29888,29889,30054,30057,30069,30070,30108,30143,30144,30146,30160,30283,30293,30294,30295,30299,30301,30326,30672,30673,30674,30802,30808,30814,30823,30867,30868,30869,30881,30883,30884,30918,31117,31124,31125,31126,31208,31209,31211,31212,31213,31220,31223,31228,31229,31230,31380,31382,31383,31569,31570,31571,31572,31574,31575,31584,31585,31589,31616,31641,31642,31643,31661,31665,31670,31672,31679,31680,31687,31821,31825,31828,31829,31842,31848,31849,31850,31866,31867,31868,31876,31878,31930,31935,32175,32176,32385,32386,32387,32388,32389,32392,32554,33142,33143,33145,33158,33159,33160,33167,33191,33201,33202,33206,33371,33592,33596,33597,33599,33603,33604,33605,33619,33831,33872,33873,33876,33878,33879,33880,33881,33882,33886,33891,33917,34151,34293,34295,34299,34460,34471,34482,34483,34485,34486,34487,34490,34491,34492,34493,34497,34498,34499,34692,34720,34753,34859,34861,34914,34919,34935,34936,34938,34939,34948,34949,34950,34952,34953,34954,35029,35030,35098,35099,35100,35101,35102,35104,35110,35363,35364,35541,35542,35545,35546,35550,35551,36554,36563,37116,37117,37243,44378,44379,44394,44395,44400,44402,44403,44404,44413,44416,44425,44445,44446,44448,44457,44461,44543,44544,44545,44546,44548,44549,44561,44572,44745,45182,45234,45241,45242,45243,46867,46908,46909,46910,46913,46914,46915,46916,46917,46924,46945,46946,46947,46949,46951,46952,46953,46968,46989,47000,47193,47195,47196,47197,47198,47199,47200,47201,47202,47203,47220,47221,47230,47231,47236,47241,47245,47246,47247,47258,47259,47260,47266,47267,47268,47283,47383,47422,47509,47511,47515,47516,47517,47535,47536,47537,47540,47558,47559,47560,47569,47570,47573,47577,47580,47581,47585,47586,47587,47588,47666,47750,47753,47757,47758,47788,47930,47948,48108,48153,48181,48301,48389,48391,48392,48393,48411,48432,48433,48434,48438,48483,48484,48488,48492,48494,48495,48496,48499,48500,48504,48505,48506,48514,48532,48539,48544,48962,48963,48965,48978,48979,48982,49004,49016,49018,49024,49027,49028,49036,49039,49042,49088,49137,49143,49149,49182,49184,49188,49194,49203,49206,49219,49222,49224,49226,49376,49377,49390,49391,49455,49483,49500,49501,49508,49509,49529,49530,49538,49542,49562,49564,49565,49567,49568,49571,49572,49588,49589,49610,49611,49627,49628,49657,49786,49787,50029,50034,50040,50041,50115,50137,50138,50147,50163,50227,50288,50322,50334,50365,50371,50384,50385,50391,50392,50421,50434,50435,50463,50516,50536,50685,50686,50687,50720,50725,50796,50887,51052,51099,51123,51124,51127,51128,51160,51179,51180,51181,51185,51271,51459,51460,51462,51466,51468,51470,51472,51473,51480,51481,51482,51483,51485,51490,51522,51523,51524,51525,51526,51527,51528,51529,51530,51533,51554,51555,51556,51557,51558,51562,51563,51564,51585,51625,51626,51632,51664,51665,51667,51679,51680,51682,51690,51692,51693,51696,51698,51699,51700,51701,51708,51709,51710,51713,51745,51746,51881,51983,51986,52143,52234,52284,52437,52752,52783,52785,52786,52795,52797,52798,52825,52858,53137,53138,53148,53175,53176,53178,53179,53180,53181,53182,53183,53184,53186,53187,53203,53204,53205,53209,53220,53221,53222,53224,53228,53230,53232,53234,53237,53238,53241,53243,53252,53253,53256,53257,53259,53260,53262,53263,53264,53270,53290,53295,53296,53298,53299,53301,53302,53303,53304,53375,53376,53380,53381,53382,53385,53390,53398,53401,53403,53409,53411,53426,53427,53429,53430,53434,53450,53451,53476,53477,53478,53479,53480,53481,53482,53483,53485,53486,53488,53490,53497,53503,53508,53511,53512,53514,53515,53516,53517,53551,53554,53555,53556,53557,53563,53569,53576,53592,53595,53600,53646,53652,53655,53656,53657,53671,53672,53673,53695,53696,53709,53710,53754,53759,53817,54044,54131,54149,54151,54181,54227,54274,54276,54277,54354,54370,54486,54637,54646,54648,54734,54787,54817,54879,55021,55050,55061,55062,55080,55090,55094,55095,55233,55339,55340,55610,55666,55667,55709,55741,56112,56314,56315,56333,56336,56339,56340,56341,56342,56343,56453,56611,56636,56637,56638,56822,56835,57318,57319,57470,57472,57499,57514,57516,57518,57519,57529,57531,57669,57761,57810,57811,57812,57878,57880,57893,58179,58180,58410,58413,58422,58423,58426,58427,58683,58684,59052,59057,59071,59578,59672,59673,59887,59888,60103,60188,60433,60503,60946,60947,60955,60956,60970,61216,61221,61295,61329,61336,61345,61346,61391,61610,61680,61681,61682,61683,61684,61685,61686,61687,61688,61689,61690,61777,61851,61882,62099,62618,62758,62759,62760,62762,62764,62765,62905,62908,63106,63108,63156,63158,63165,63167,63373,63374,63375,63457,63458,63468,63534,63542,63544,63560,63574,63611,63621,63622,63625,63626,63646,63647,63648,63675,63685,63730,63731,63733,63735,63896,63900,64044,64058,64127,64128,64129,64343,64368,64370,64371,64695,64701,64803,64976,65081,65139,65142,65264,65661,66191,66192,66235,67481,68055,68766,69369,70893,70940,71162,71165,71521,71757,75447,75806,76547,76595,76613,76657,76658,76659,76663,76669,76671,76672,76691,76803,76806,76808,76838,76856,76857,76858,77130,77215,77219,77220,77222,77223,77226,77478,77484,77485,77486,77487,77489,77492,77493,77494,77495,77513,77514,77515,77536,77537,77538,77613,77655,77656,77657,77700,77701,77746,77747,77755,77756,77762,77794,77795,77796,77800,77829,77830,78202,78203,78204,78228,78500,78501,78674,78675,78734,78735,78736,78784,78785,78788,78789,78892,78893,79004,79007,79008,79077,79079,79095,79096,79121,79122,79123,79124,79125,79126,79132,79133,79134,79136,79140,79141,79146,79147,79150,79151,79152,80128,80129,80240,80313,80314,80315,80316,80317,80318,80319,80552,80553,80861,80863,80879,80886,80951,80976,80977,80979,80980,81006,81016,81017,81021,81022,81061,81062,81069,81093,81099,81125,81127,81130,81131,81132,81135,81136,81138,81141,81163,81164,81191,81192,81256,81262,81274,81275,81283,81291,81292,81326,81327,81328,81330,81331,81332,81333,81334,81338,81339,81340,81625,81659,81660,81661,81662,81749,81751,81913,81914,82368,82682,82683,82684,82687,82692,82726,82748,82749,82832,82833,82834,82893,82894,82898,82899,82921,82925,82930,82984,82987,82988,83046,83047,83049,83050,83074,83077,83098,83154,83156,83157,83162,83239,83301,83302,83340,83356,83359,83489,83490,83494,83495,83513,83515,83558,83559,83560,83582,83619,83676,83853,84253,84254,84570,84571,84572,84579,84580,84583,84584,84585,84586,84587,84588,84601,84604,84607,84608,84614,84615,84617,84619,84620,84621,84626,84627,84628,84629,84631,84633,84635,84636,84652,84653,84654,84661,84668,84669,84671,84673,84674,84721,84722,84723,84726,84727,84729,84732,84735,84739,84740,84748,84800,84839,84840,84846,84847,84848,84854,84993,84994,85043,85099,85100,85101,85102,85103,85104,85105,85106,85107,85108,85109,85110,85112,85113,85114,85117,85126,85175,85222,85256,85283,85284,85285,85288,85383,85384,85386,85388,85416,85421,85433,85446,85457,85458,85462,85463,85464,85479,85495,85497,85498,85499,85509,85510,85511,85512,85547,85639,85646,85696,85730,85738,85739,85741,85742,85793,85794,85795,85803,85804,86000,86105,86121,86172,86181,86183,86184,86185,86209,86259,86260,86273,86303,86304,86314,86392,86500,86508,86624,86627,86629,86655,86662,86663,86664,86667,86759,86880,86894,86896,86914,86935,86936,86948,86949,86958,86959,86961,86962,87023,87095,87096,87098,87099,87100,87138,87151,87163,87164,87168,87172,87173,87174,87175,87189,87192,87193,87194,87195,87204,87305,87325,87326,87327,87335,87336,87339,87426,87430,87431,87461,87934,87935,88063,88263,88423,88433,88446,88447,88448,88453,88466,88625,88627,88675,88676,88687,88688,88690,88691,88756,88764,88765,88766,88767,88819,88820,88821,88852,88994,88995,89023,89024,89388,89485,89488,89489,89603,89604,89605,89901,89906,90286,90787,90788,90806,90811,91021,91023,91107,91145,91316,91319,91323,91342,91394,91711,91713,91724,91986,92295,92297,92363,92364,92931,93068,93098,93099,93398,93399,93400,93401,93402,93417,93418,93974,93987,94006,94007,94286,94288,94289,94472,94553,94555,95649,95740,95859,95860,95861,95862,95969,96103,96172,96206,96263,96265,96266,96267,96268,96269,96270,96429,97547,97618,97954,97985,98008,98440,99560
);

$outf = fopen("Char_spell_cleaned.sql","w");
$get_query3 = "SELECT guid,spells,name FROM characters order by guid asc"; 
$get_res=mysql_query($get_query3,$dbi) or die(" Q2006112315011 ".mysql_error($dbi)." $get_query3 ");
$counter=0;
while( list($guid,$spells,$name)=mysql_fetch_row($get_res) )
{
	$removed_spells="";
	$len_before = strlen($spells);
	$spells_list = explode(",",$spells);
	$spells = ",".$spells.",";
	foreach($spells_list as $key => $rem_spell)
	if( $rem_spell )
	{
		if( array_search($rem_spell,$remove_spells_from_char) )
		{
//$get_query1 = "SELECT name,description FROM dbc_spell where id=$rem_spell"; 
//$get_res1=mysql_query($get_query1,$dbi) or die(" Q2006112315011 ".mysql_error($dbi)." $get_query3 ");
//list($sname,$sdesc)=mysql_fetch_row($get_res1);
//echo "found $rem_spell - $sname - $sdesc<br>";
			$spells = str_replace(",".$rem_spell.",",",",$spells);
			$made_replace = 1;
			$removed_spells.="$rem_spell,";
		}
	}
	if( $removed_spells!="" )
	{
$counter++;
//echo "#$counter)Removed some spells from char with name and guid $name = $guid. The spells : $removed_spells<br>";
fwrite( $outf, "#$counter)Removed some spells from char with name and guid $name = $guid. The removed spells : $removed_spells \n");
		$spells = str_replace(",,",",",$spells);
		$query = "Update characters set spells='$spells' where guid=$guid;";
//echo "$query <br>";
fwrite( $outf, "$query \n");
//		$get_res2=mysql_query($query,$dbi) or die(" Q2006112315011 ".mysql_error($dbi)." $query ");
	}
}
?>